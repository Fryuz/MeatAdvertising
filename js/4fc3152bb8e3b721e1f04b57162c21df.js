function error_position(e,t){var a=$("input[name="+e+"], textarea[name="+e+"], select[name="+e+"]",t),r=$(".error_"+e,t);if("absolute"===r.css("position")){var n=a.offset();n.top+=a.outerHeight(),n.left+=5,r.offset(n)}}$(document).on("submit","form.ajax",(function(){return diafan_ajax.init(this)}));var diafan_ajax={before:{},success:{},tag:!1,options:{manager:!0},init:function(e){return this.tag=$("input[name=module]",e).val()+"_"+$("input[name=action]",e).val(),this.before[this.tag]&&!1===this.before[this.tag](e)||($("input:submit",e).attr("disabled","disabled"),$(".errors").hide(),$(".error_input").removeClass("error_input"),$("input[name=ajax]",e).length||$(e).append('<input type="hidden" name="ajax" value="1">'),this.options.manager?this.manager.addForm(e):($(e).trigger("order_ajax_submit.before",[e,1]),this.onSubmitBefore(e,1),$(e).ajaxSubmit({success:function(e,t,a,r){diafan_ajax.result(r,e),$(document).trigger("order_ajax_submit.after",[r,0]),diafan_ajax.manager.onSubmitAfter(r,0),$(document).trigger("order_ajax_submit.after_last",[r]),diafan_ajax.manager.onSubmitAfterLast(r)}})),$(":text, :password, input[type=email], input[type=tel], textarea, select, :radio, :checkbox",e).change((function(){$("body").attr("name")&&$(".error_"+$("body").attr("name").replace(/\[|\]/gi,""),e).hide(),$(this).removeClass("error_input")}))),!1},result:function(e,t){$("input:submit",e).removeAttr("disabled");try{var a=$.parseJSON(t)}catch(e){return $("body").append(t),$(".diafan_div_error").css("left",$(window).width()/2-$(".diafan_div_error").width()/2),$(".diafan_div_error").css("top",$(window).height()/2-$(".diafan_div_error").height()/2+$(document).scrollTop()),$(".diafan_div_error_overlay").css("height",$("body").height()),!1}if(a.log&&console.log(a.log),a.profiler&&($(".devoloper_profiling[ajax]").remove(),$(".devoloper_profiler[ajax]").remove(),$("body").append(prepare(a.profiler)),delete a.profiler),this.success[this.tag]&&!1===this.success[this.tag](e,a))return!1;var r=$(e).find("input[name='captcha_update']").val();if(a.captcha)if("recaptcha"==a.captcha){var n=$(".js_captcha",e).find("div").first();grecaptcha.reset(recaptcha[n.attr("id")])}else $(".captcha",e).html(prepare(a.captcha)).show();if(!r&&a.errors&&($.each(a.errors,(function(t,a){if(0==t)$(".error",e).length?$(".error",e).addClass("error_message").html(prepare(a)).show():$(e).parent().find(".error").addClass("error_message").html(prepare(a)).show();else{var r=$("input[name="+t+"], textarea[name="+t+"], select[name="+t+"]",e);$(".error_"+t,e).addClass("error_message").html(prepare(a)).show(),r.length&&(r.addClass("error_input").addClass("focus_input"),error_position(t,e))}})),$(".focus_input:first",e).focus(),$(".focus_input").removeClass("focus_input")),a.result&&"success"==a.result&&($(e).clearForm(),$(e).find(".inpattachment input:file").each((function(){if($(this).parents(".inpattachment").is(":hidden")){var e=$(this).parents(".inpattachment");e.before(e.clone(!0)),e.prev(".inpattachment").show();var t=str_replace("hide_","",e.prev(".inpattachment").find("input").val("").attr("name"),0);e.prev(".inpattachment").find("input").val("").attr("name",t)}else $(this).parents(".inpattachment").remove()})),$("input:file",e).removeClass("last"),$("input:file",e).val(""),$(".inpimages",e).length&&$(".images").text("")),a.add&&($("."+$(e).attr("id")).append(prepare(a.add)).show(),$(".error:empty").hide()),a.redirect&&(window.location=prepare(a.redirect)),a.curLoc){var i=prepare(a.curLoc);diafan_ajax.set_location(i)}a.set_location&&diafan_ajax.set_location($(e).attr("action")),a.data&&($.each(a.data,(function(t,r){"form"==t&&(t=e),r?a.replace?$(t).replaceWith(prepare(r)).show():($(t).contents().remove(),$(t).append(prepare(r)).show()):a.replace?$(t).replaceWith("").show():$(t).hide()})),$(".error:empty").hide()),a.attachments&&$.each(a.attachments,(function(t,a){if($(e).find(".attachment[name='"+t+"']").remove(),$(e).find(".inpattachment input[name='"+t+"']").parents(".inpattachment").remove(),$(e).find(".inpattachment input[name='hide_"+t+"']").parents(".inpattachment").before(prepare(a)),$(e).find(".attachment[name='"+t+"']").show(),$(e).find(".inpattachment input[name='hide_"+t+"']").attr("max")>$(e).find(".attachment[name='"+t+"']").length){var r=$(e).find("input[name='hide_"+t+"']").parents(".inpattachment");r.before(r.clone(!0)),r.prev(".inpattachment").show(),r.prev(".inpattachment").find("input").val("").attr("name",t)}})),a.images&&$.each(a.images,(function(t,a){$(e).find("input[name='"+t+"']").val(""),$(e).find("input[name='"+t+"']").parents("div").first().find(".image").remove(),0==a&&(a=""),$(e).find("input[name='"+t+"']").before(prepare(a))})),a.hash&&$("input[name=check_hash_user]").val(a.hash),a.js&&$.each(a.js,(function(e,t){t&&(t.src&&(t.src=prepare(t.src)),t.func&&(t.func=prepare(t.func)),diafan_ajax.manager.addScript(t.src,t.func))})),a.css&&$.each(a.css,(function(e,t){t&&diafan_ajax.manager.addCSS(prepare(t))}));var o=$(".diafan_errors[ajax_errors]"),s=$(".diafan_errors:not([ajax_errors])");if(o.length){n=$("a[diafan_errors]").length+1;$("a[ajax_errors]").each((function(){if($(this).closest(".diafan_errors").length)return!0;$(this).removeAttr("ajax_errors").attr("diafan_errors","").attr("href","#error"+n).text("[ERROR"+n+"]"),$(this).next(".diafan_errors").find("a[ajax_errors]").eq(0).removeAttr("ajax_errors").attr("name","error"+n),n+=1})),s.length?(s.find("table tr").after(o.find("table tr")),o.remove(),$(".diafan_div_error").css("left",$(window).width()/2-$(".diafan_div_error").width()/2),$(".diafan_div_error").css("top",$(window).height()/2-$(".diafan_div_error").height()/2+$(document).scrollTop()),$(".diafan_div_error_overlay").css("height",$("body").height())):(o.appendTo("body"),$(".diafan_div_error").css("left",$(window).width()/2-$(".diafan_div_error").width()/2),$(".diafan_div_error").css("top",$(window).height()/2-$(".diafan_div_error").height()/2+$(document).scrollTop()),$(".diafan_div_error_overlay").css("height",$("body").height()),o.removeAttr("ajax_errors"),void 0===window.base_path&&(window.base_path=""),diafan_ajax.manager.addScript(window.base_path+"adm/js/admin.errors.js"))}return!1},manager:{order:[],count:function(){var e=0;return this.order.forEach((function(t,a,r){e++})),e},curForm:{},flag_busy:!1,addForm:function(e){return this.order.push(e),this.run(),this},onSubmitBefore:function(e,t){},onSubmitAfter:function(e,t){},onSubmitAfterLast:function(e){},onSubmitError:function(e,t){},run:function(){var e=this.count();return!this.flag_busy&&e>0&&(this.flag_busy=!this.flag_busy,this.curForm=this.order.shift(),$(this.curForm).trigger("order_ajax_submit.before",[this.curForm,e]),this.onSubmitBefore(this.curForm,e),$(this.curForm).ajaxSubmit({async:!0,beforeSubmit:function(e,t,a){return!0},success:function(e,t,a,r){diafan_ajax.result(r,e);var n=diafan_ajax.manager.count();$(document).trigger("order_ajax_submit.after",[r,n]),diafan_ajax.manager.onSubmitAfter(r,n),n<=0&&($(document).trigger("order_ajax_submit.after_last",[r]),diafan_ajax.manager.onSubmitAfterLast(r))},error:function(e,t,a){$(document).trigger("order_ajax_submit.error",[diafan_ajax.manager.curForm,a]),diafan_ajax.manager.onSubmitError(diafan_ajax.manager.curForm,a)},complete:function(e,t){diafan_ajax.manager.curForm={},diafan_ajax.manager.flag_busy=!1,diafan_ajax.manager.count()>0&&diafan_ajax.manager.run()}})),this},js_view:[],inArray:function(e,t){return $.inArray(e,t)},addScript:function(e,t){return t=t||"",(e=e||"")&&!$('script[src="'+e+'"]').length&&-1===this.inArray(this.js_view,e)?(this.js_view.push(e),$._cachedScript(e).done((function(e,t){}))):t&&"function"==typeof window[t]&&window[t](),this},addCSS:function(e){return(e=e||"")&&!$('link[href="'+e+'"][type="text/css"]').length&&$("head").append('<link rel="stylesheet" href="'+e+'" type="text/css" rel="stylesheet" charset="utf-8">'),this},isEmpty:function(e){for(var t in e)return!1;return!0}},set_location:function(e){e=e.replace(window.location.protocol+"//"+window.location.host+"/","");try{return history.pushState(null,null,"/"+e),!0}catch(e){}for(var t=(e=e.replace(/[\#|\?|\.](.*?)$/gi,"")).split(/\s*\/\s*/),a="";t.length;)if(a=t.pop().replace(/[^\w]*/,"")){window.chHashFlag=!0,location.hash="#"+a;break}return!1}};diafan_ajax.manager.inArray=[].indexOf?function(e,t){return e.indexOf(t)}:function(e,t){for(var a=0;a<e.length;a++)if(e[a]===t)return a;return-1},jQuery._cachedScript=function(e,t){return t=$.extend(t||{},{dataType:"script",cache:!1,url:e}),jQuery.ajax(t)},function(e){e.fn.hasEvent=function(t,a){if(!this.length||!t)return!1;t=t.split(/\s*\.\s*/),namespace=t[1]||!1,t=t[0],a=a||!1;var r=!1,n=e._data(this.get(0),"events");return n&&e.each(n,(function(n,i){return n!=t||(namespace||a?i&&e.each(i,(function(e,t){return!t||(!(!namespace||namespace==t.namespace)||(!(!a||t.handler==a)||(r=!0,!1)))})):r=!0,!1)})),r}}(jQuery);var defer_loading={options:{container:window,emergence:{async:!0,debounce:250},timeout:3e3},_core:{flag_init:!1,defer_id:0,objects:function(){return $('form input[name="defer"]').filter(":not([loading=true])")},prepare_async:function(e){return e.length?(this.defer_id++,e.attr("defer_id",this.defer_id).append('<input type="hidden" name="ajax_async" value="1">').find("input").filter('[name^="attributes"]').each((function(){var e=$(this).attr("name").replace(/^attributes/gi,"attributes["+defer_loading._core.defer_id+"]");$(this).attr("name",e)})),e):e},before_submit:function(e,t,a){if($(t).length&&"true"==$(t).attr("loading")&&$(t).find('input[name="defer"]').eq(0).length){var r={};$(t).find("[name ^= attributes]").each((function(){var e=$(this).attr("name").split(/\[([^\]]*)\]/g);if(5!=e.length)return!0;var t=e[1].replace(/\D+/g,"");if(!t||r[t])return!0;r[t]=!0;var a=$('form[defer_id="'+t+'"]');if(!a.length)return!0;a.delay(defer_loading.options.timeout).hide(0)})),$(t).delay(defer_loading.options.timeout).hide(0)}},after_submit:function(e,t){var a=defer_loading._core.objects();a.length?a.filter('[value="async"]').length||a.filter('[value="sync"]').length?defer_loading.load():a.filter('[value="emergence"]').length||defer_loading.destroy():defer_loading.destroy()},viewport:function(e){var t=$(e).offset()||{top:0,left:0};return e=e||defer_loading.options.container,{x:$(e).scrollLeft(),y:$(e).scrollTop(),left:t.left,top:t.top,width:$(e).outerWidth(!0),height:$(e).outerHeight(!0)}},in_viewport:function(e,t){var a=function(e,t,a,r){var n=0;return(e=e||0)>(t=t||0)&&(n=e,e=t,t=n),(a=a||0)>(r=r||0)&&(n=a,a=r,r=n),e>r?-2:t<a?2:e>a&&t>=r?-1:e<=a&&t<r?1:0},r=a(e.y,e.y+e.height,t.top,t.top+t.height);return horizontal=a(e.x,e.x+e.width,t.left,t.left+t.width),r>-2&&r<2&&horizontal>-2&&horizontal<2}},init:function(){return!(this._core.flag_init||!this._core.objects().length)&&(this._core.flag_init=!0,$(document).hasEvent("order_ajax_submit.before",this._core.before_submit)||$(document).on("order_ajax_submit.before",this._core.before_submit),$(document).hasEvent("order_ajax_submit.after_last",this._core.after_submit)||$(document).on("order_ajax_submit.after_last",this._core.after_submit),$(this.options.container).hasEvent("scroll",this.emergence)||$(this.options.container).on("scroll",{async:this.options.emergence.async},this.emergence.debounce(this.options.emergence.debounce)),$(this.options.container).hasEvent("resize",this.emergence)||$(this.options.container).on("resize",{async:this.options.emergence.async},this.emergence.debounce(this.options.emergence.debounce)),$(document).hasEvent("submit",defer_loading.event)||$(document).on("submit","form.js_block_defer_form",this.event),this.load(),this.load_in_viewport(!0),!0)},destroy:function(){return!!this._core.flag_init&&($(this.options.container).off("scroll",this.emergence),$(this.options.container).off("resize",this.emergence),$(document).off("order_ajax_submit.after_last",this._core.after_submit),$(document).off("order_ajax_submit.before",this._core.before_submit),this._core.flag_init=!1,!0)},load:function(){var e=$();$('form input[name="defer"][value="async"]').each((function(){defer_loading._core.defer_id++,e.length?defer_loading._core.prepare_async($(this).attr("loading","true").closest("form")).attr("loading","true").find("input").filter('[name^="attributes"]').appendTo(e):e=defer_loading._core.prepare_async($(this).attr("loading","true").closest("form")).attr("loading","true")})),e.length&&e.submit(),$('form input[name="defer"][value="sync"]').each((function(){$(this).attr("loading","true").closest("form").attr("loading","true").submit()}))},load_in_viewport:function(e){e=e||!1;var t=defer_loading._core.viewport(),a={};if(e){var r=$();$('form input[name="defer"][value="emergence"]').filter(":not([loading=true])").each((function(){var e=$(this).closest("form");if(a=defer_loading._core.viewport(e),!defer_loading._core.in_viewport(t,a))return!0;$(this).attr("loading","true"),defer_loading._core.prepare_async(e).attr("loading","true"),r.length?e.find("input").filter('[name^="attributes"]').appendTo(r):r=e})),r.length&&r.submit()}else $('form input[name="defer"][value="emergence"]').filter(":not([loading=true])").each((function(){var e=$(this).closest("form");if(a=defer_loading._core.viewport(e),!defer_loading._core.in_viewport(t,a))return!0;$(this).attr("loading","true"),e.attr("loading","true"),e.submit()}));return this},emergence:function(e){var t=!1;void 0!==e&&void 0!==e.data&&"async"in e.data&&(t=e.data.async),defer_loading.load_in_viewport(t)},event:function(e){return $(this).attr("loading","true").find('input[name="defer"][value="event"]').attr("loading","true"),!1}};Function.prototype.defer=function(e,t,a){var r=this;return setTimeout((function(){r.apply(t,a||[])}),e)},Function.prototype.debounce=function(e,t){var a,r=this;return function(){var n=arguments,i=this;clearTimeout(a),a=setTimeout((function(){r.apply(t||i,n)}),e)}},$(window).on("load",(function(e){$(document).on("order_ajax_submit.after_last",(function(e,t){"function"==typeof window.init_main&&window.init_main(),defer_loading.init()})),defer_loading.init()}));var diafan_cookie={get:function(e){if(!this.isEnable())return!1;var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):void 0},set:function(e,t,a){if(!this.isEnable())return!1;var r=(a=a||{}).expires;if("number"==typeof r&&r){var n=new Date;n.setTime(n.getTime()+1e3*r),r=a.expires=n}r&&r.toUTCString&&(a.expires=r.toUTCString());var i=e+"="+(t=encodeURIComponent(t));for(var o in a){i+="; "+o;var s=a[o];!0!==s&&(i+="="+s)}document.cookie=i},delete:function(e){if(!this.isEnable())return!1;setCookie(e,"",{expires:-1})},isEnable:function(){return!!navigator.cookieEnabled}};function prepare(e){return e=str_replace("&lt;","<",e),e=str_replace("&gt;",">",e),e=str_replace("&amp;","&",e)}function str_replace(e,t,a,n){for(f=[].concat(e),r=[].concat(t),s=a,ra=r instanceof Array,sa=s instanceof Array,s=[].concat(s),n&&(this.window[n]=0),i=0,sl=s.length;i<sl;i++)if(""!==s[i])for(j=0,fl=f.length;j<fl;j++)temp=s[i]+"",repl=ra?void 0!==r[j]?r[j]:"":r[0],s[i]=temp.split(f[j]).join(repl),n&&s[i]!==temp&&(this.window[n]+=(temp.length-s[i].length)/f[j].length);return sa?s:s[0]}function get_selected(e,t){var a="string"==typeof e?$(e+" option:first-child",t):$("option:first-child",e);return $(e,t).find("option").each((function(){if("selected"===$(this).attr("selected"))return a=$(this),!1})),a}$(document).on("click",".error_message",(function(){$(this).hide()})),$(document).on("change",".inpfiles",(function(){var e=$(this).parents(".inpattachment");if(!$(this).attr("max")||$(this).parents("form").find('input[name="'+$(this).attr("name")+'"], .attachment[name="'+$(this).attr("name")+'"]').length<$(this).attr("max")){var t=$(this).parents("form").find('input[name="hide_'+$(this).attr("name")+'"]').parents(".inpattachment");t.before(t.clone(!0)),t.prev(".inpattachment").show().find("input").val("").attr("name",$(this).attr("name"))}e.find(".inpattachment_delete").length||e.append(' <a href="javascript:void(0)" class="inpattachment_delete">x</a>')})),$(document).on("click",".inpattachment_delete",(function(){var e=$(this).parents(".inpattachment"),t=e.find(".inpfiles");if(t.parents("form").find('input[name="'+t.attr("name")+'"]').last().val()){var a=$(this).parents("form").find('input[name="hide_'+t.attr("name")+'"]').parents(".inpattachment");a.before(a.clone(!0)),a.prev(".inpattachment").show().find("input").val("").attr("name",t.attr("name"))}return e.remove(),!1})),$(document).on("click",".attachment_delete",(function(){var e=$(this).parents(".attachment");e.find("input[name='hide_attachment_delete[]']").attr("name","attachment_delete[]"),e.hide().removeClass("attachment");var t=e.parents("form").find('input[name="'+e.attr("name")+'"]').last();if(!t.length||t.val()){var a=$(this).parents("form").find("input[name='hide_"+e.attr("name")+"']").parents(".inpattachment");a.before(a.clone(!0)),a.prev(".inpattachment").show(),a.prev(".inpattachment").find("input").val("").attr("name",e.attr("name"))}return!1})),$(document).on("change",".inpimages",(function(){var e=$(this).parents("form"),t=$(this);e.ajaxSubmit({dataType:"json",data:{ajax:1,images_param_id:t.attr("param_id"),images_prefix:t.attr("prefix"),action:"upload_image"},beforeSubmit:function(e,t,a){$(".errors").hide()},success:function(a){a.hash&&$("input[name=check_hash_user]").val(a.hash),a.data&&(t.prev(".images").html(prepare(a.data)),t.val("")),a.errors&&$.each(a.errors,(function(t,a){e.find(".error"+(0!=t?"_"+t:"")).html(prepare(a)).show()}))}})})),$(document).on("click",".image_delete",(function(){var e=$(this).parents(".image"),t=$(this).parents("form");return $.ajax({url:window.location.href,type:"POST",dataType:"json",data:{module:t.find("input[name=module]").val(),action:"delete_image",ajax:!0,element_id:t.find("input[name=id]").val(),tmpcode:t.find("input[name=tmpcode]").val(),id:e.find("img").attr("image_id"),check_hash_user:$("input[name=check_hash_user]").val()},success:function(e){e.hash&&$("input[name=check_hash_user]").val(e.hash)}}),e.remove(),!1})),$(".timecalendar").each((function(){var e=$(this).attr("showtime");e&&e.match(/true/i)?($(this).datetimepicker({dateFormat:"dd.mm.yy",timeFormat:"hh:mm",language:"ru",changeMonth:!0,changeYear:!0}),new IMask(this,{mask:"00.00.0000 00:00"})):($(this).datepicker({dateFormat:"dd.mm.yy",changeMonth:!0,changeYear:!0}),new IMask(this,{mask:"00.00.0000"}))})),$(document).on("keydown","input[type=number], input.number",(function(e){if((e=e||(window.event?event:null))&&(e.target?e.target:e.srcElement?e.srcElement:null)){var t=e.charCode?e.charCode:e.which?e.which:e.keyCode;return t<32||t>44&&t<47||t>95&&t<106||t>47&&t<58||188==t||191==t||190==t||110==t}})),$(".js_mask").each((function(){new IMask(this,{mask:$(this).attr("mask")})})),$(".error:empty").hide(),$(document).on("click","a[rel=large_image]",(function(){var e=$(this);return window.open(e.attr("href"),"","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+(1*e.attr("width")+40)+",height="+(1*e.attr("height")+40)),!1}));